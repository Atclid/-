name: Fix Missing Files and Build Mod

on: [push]

jobs:
  fix-missing-files:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # 步骤1：生成Gradle Wrapper（如果缺失）
    - name: Generate Gradle Wrapper
      if: "! -f 'gradlew' || ! -f 'gradlew.bat' || ! -d 'gradle/wrapper'"
      run: |
        # 安装Gradle用于生成Wrapper
        sudo apt-get update
        sudo apt-get install -y gradle

        # 生成Wrapper（指定版本为8.4）
        gradle wrapper --gradle-version=8.4 --distribution-type=bin

        # 提交生成的Wrapper文件（如果之前缺失）
        if [ ! -f "gradlew" ] || [ ! -f "gradlew.bat" ] || [ ! -d "gradle/wrapper" ]; then
          git config user.email "fix-bot@github.com"
          git config user.name "Fix Bot"
          git add gradlew gradlew.bat gradle/wrapper
          git commit -m "Automatically generated Gradle Wrapper"
          git push
        fi

    # 步骤2：创建mods.toml（如果缺失）
    - name: Create mods.toml if missing
      run: |
        MODS_TOML_PATH="src/main/resources/META-INF/mods.toml"
        if [ ! -f "$MODS_TOML_PATH" ]; then
          mkdir -p "$(dirname "$MODS_TOML_PATH")"
          cat << EOF > "$MODS_TOML_PATH"
        modLoader="javafml"
        loaderVersion="[47,)"
        license="All Rights Reserved"

        [[mods]]
        modId="bonsaitree"
        version="1.0"
        displayName="Bonsai Tree Mod"
        authors="YourName"
        description='''添加可在耕地上种植的盆景树苗种子'''
        EOF
          # 提交生成的mods.toml
          git config user.email "fix-bot@github.com"
          git config user.name "Fix Bot"
          git add "$MODS_TOML_PATH"
          git commit -m "Automatically created mods.toml"
          git push
        fi

  build-mod:
    needs: fix-missing-files
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Grant execute permission
      run: chmod +x gradlew
    - name: Build mod
      run: ./gradlew build --no-daemon
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: bonsai-mod
        path: build/libs/*.jar
